#!/bin/bash
# VNC xstartup script

# Clean environment
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS

# Set display
export DISPLAY=${DISPLAY:-:1}

echo "🔧 Starting VNC desktop environment on $DISPLAY"

# Load user X resources if available
[ -r "$HOME/.Xresources" ] && xrdb "$HOME/.Xresources"

# Set background color
xsetroot -solid '#2e3440' 2>/dev/null || echo "⚠️  Could not set background"

# Start vncconfig for clipboard support
vncconfig -iconic & disown

# Wait for display to be ready
echo "⏳ Waiting for display $DISPLAY to be ready..."
i=0
while ! xdpyinfo -display "$DISPLAY" >/dev/null 2>&1; do
    sleep 1
    i=$((i+1))
    if [ $i -ge 30 ]; then
        echo "❌ Display $DISPLAY not ready after 30 seconds"
        exit 1
    fi
    if [ $((i % 5)) -eq 0 ]; then
        echo "   Still waiting... ($i/30)"
    fi
done

echo "✅ Display $DISPLAY is ready"

# Start window manager (lightweight)
echo "🪟 Starting window manager..."
twm & disown
sleep 2

# Start a terminal
echo "💻 Starting terminal..."
xterm -geometry 80x30+50+50 -ls -title 'Agent Workspace' -e bash & disown

echo "🎉 VNC desktop environment started successfully"

# Keep the script running
wait